var carbon=function(e,t){"use strict";this.options=_.assignIn({legend:"","default":carbon.default,data:"search",columns:carbon.columns,name:carbon.getUID(),schema:e.fields},this.opts,e),this.el=document.querySelector(t||e.el),this.on=this.events.on,this.trigger=this.events.trigger,this.debounce=this.events.debounce,"string"==typeof this.options.data&&(this.options.data=window.location[this.options.data].substr(1).split("&").map(function(e){return e.split("=")}).reduce(function(e,t){return e[t[0]]=decodeURIComponent(t[1]),e},{})),this.options.sections&&_.each(_.filter(this.options.schema,{type:"fieldset"}),function(e,t){return e.index=t,e.section=!0,e}),this.trigger("initialize");var n=function(){this.options.clear&&(this.el.innerHTML=carbon.render(this.options.sections+"_container",this.options)),this.container=this.el.querySelector((t||e.el)+" form")||this.el,this.rows={},this.fields=_.map(this.options.schema,carbon.createField.bind(this,this,this.options.data||{},null,null)),_.each(this.fields,carbon.inflate.bind(this,this.options.data||{})),_.each(this.fields,function(e){e.owner.events.trigger("change:"+e.name,e)}),carbon.instances[this.options.name]=this};this.restore=n.bind(this);var i=function(e){if("string"==typeof e)return _.find(this.fields,{name:e}).get();var t={};return _.each(this.fields,function(e){e.parsable&&(e.fields?e.array?(t[e.name]=t[e.name]||[],t[e.name].push(i.call(e))):t[e.name]=i.call(e):e.array?(t[e.name]=t[e.name]||[],t[e.name].push(e.get())):t[e.name]=e.get())}.bind(this)),t};this.toJSON=i.bind(this),n.call(this),this.set=function(e,t){_.find(this.fields,{name:e}).set(t)}.bind(this),this.find=function(e){return _.find(this.fields,{name:e})}.bind(this),this.isActive=!0,this.active=function(){return this.isActive},this.destroy=function(){this.trigger("destroy"),this.el.innerHTML="",delete carbon.instances[this.options.name],this.trigger("destroyed")}};carbon.m=function(e,t,n,i){function s(e,t){return t=t.pop?t:t.split("."),e=e[t.shift()]||"",0 in t?s(e,t):e}var a=carbon.m,r="";t=_.isArray(t)?t:t?[t]:[],t=i?0 in t?[]:[1]:t;for(i=0;i<t.length;i++){var o,c="",l=0,h="object"==typeof t[i]?t[i]:{},h=_.assign({},n,h);h[""]={"":t[i]},e.replace(/([\s\S]*?)({{((\/)|(\^)|#)(.*?)}}|$)/g,function(e,t,n,i,d,u,p){l?c+=l&&!d||l>1?e:t:(r+=t.replace(/{{{(.*?)}}}|{{(!?)(&?)(>?)(.*?)}}/g,function(e,t,n,i,r,o){return t?s(h,t):i?s(h,o):r?a(s(h,o),h):n?"":new Option(s(h,o)).innerHTML}),o=u),d?--l||(p=s(h,p),r=/^f/.test(typeof p)?r+p.call(h,c,function(e){return a(e,h)}):r+a(c,p,h,o),c=""):++l})}return r},carbon.instances={},carbon.inflate=function(e,t,n,i){var s=i;t.array&&(s=_.uniqBy(s,"name"));var a=_.findLast(s,{name:s[n].name});if(!a.array&&a.fields&&_.each(a.fields,carbon.inflate.bind(this,e[a.name]||{})),a.array){var r=a.array.min||0;"object"==typeof e[a.name]&&e[a.name].length>1&&e[a.name].length>r&&(r=e[a.name].length);for(var o=1;r>o;o++){var c=carbon.createField.call(this,a.parent,e,a.el,o,a.item);a.parent.fields.splice(_.findIndex(a.parent.fields,{id:a.id})+1,0,c),a=c}}},carbon.createField=function(e,t,n,i,s){s.type=s.type||this.options.default.type;var a=_.assignIn({name:(s.label||"").toLowerCase().split(" ").join("_"),id:carbon.getUID(),label:s.legend||s.name,validate:!1,valid:!0,parsable:!0,visible:!0,enabled:!0,parent:e,array:!1,columns:this.options.columns,offset:0,ischild:!(e instanceof carbon)},this.opts,carbon.default,carbon.types[s.type].defaults,s);if(a.validate.required=a.validate.required||a.required,""==a.name&&(a.name=a.id),a.item=s,a.owner=this,a.columns>this.options.columns&&(a.columns=this.options.columns),a.value=a.array&&"object"==typeof t[a.name]?t[a.name][i||0]:t[a.name]||a.value,0!==a.item.value?a.array&&"object"==typeof t[a.name]?a.value=t[a.name][i||0]:"function"==typeof a.item.value?(a.valueFunc=a.item.value,a.derivedValue=function(){return a.valueFunc.call(a,a.owner.toJSON())},a.item.value=a.item.value=a.derivedValue(),a.owner.on("change",function(){this.set.call(this,this.derivedValue())}.bind(a))):a.value=t[a.name]||a.value||"":a.value=0,a.satisfied=a.satisfied||carbon.types[a.type].satisfied.bind(a),a.update=carbon.types[a.type].update.bind(a),a.destroy=carbon.types[a.type].destroy.bind(a),a.active=function(){return this.parent.active()&&this.enabled&&this.parsable&&this.visible},a.set=function(e,t){this.value!=e&&"object"!=typeof e&&(this.value=e,carbon.types[this.type].set.call(this,e),t||this.owner.trigger("change"))}.bind(a),a.get=a.get||carbon.types[a.type].get.bind(a),a.render=a.render||carbon.types[a.type].render.bind(a),a.el=carbon.types[a.type].create.call(a),a.container=a.el.querySelector("fieldset")||null,a.target||!this.options.clear&&!a.isChild){a.target||(a.target='[name="'+a.name+'"]');var r=this.container.querySelector(a.target);"undefined"!=typeof r&&null!==r&&r.appendChild(a.el)}else{var o,c=a.parent.container.querySelectorAll("form > ."+a.owner.options.rowClass+",fieldset > ."+a.owner.options.rowClass),r=(c[c.length-1]||{}).id;if("undefined"!=typeof r&&(o=a.parent.rows[r]),"undefined"==typeof o||o.used+parseInt(a.columns,10)+parseInt(a.offset,10)>this.options.columns||1==a.row){var r=carbon.getUID();o={},o.used=0,o.ref=document.createElement("div"),o.ref.setAttribute("id",r),o.ref.setAttribute("class",a.owner.options.rowClass),a.parent.rows[r]=o,a.parent.container.appendChild(o.ref)}o.used+=parseInt(a.columns,10),o.used+=parseInt(a.offset,10),o.ref.appendChild(a.el),a.row=r}carbon.types[a.type].initialize.call(a);var l=a.el.querySelector(".carbon-add");null!==l&&l.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true<(e.array.max||5)){var t=_.findIndex(e.parent.fields,{id:e.id}),n={},i=carbon.createField.call(this,e.parent,n,e.el,null,e.item);e.parent.fields.splice(t+1,0,i),i.el.querySelector('[name="'+e.name+'"]').focus(),_.each(["change","change:"+e.name,"create:"+e.name,"inserted:"+e.name],function(t){e.owner.trigger(t,e.owner,e)}.bind(e))}}.bind(this,a));var h=a.el.querySelector(".carbon-minus");if(null!==h&&h.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true>(e.array.min||1)){var t=_.findIndex(e.parent.fields,{id:e.id});e.parent.fields.splice(t,1),e.target?this.container.querySelector(e.target).removeChild(e.el):(e.parent.rows[e.row].used-=e.offset+e.columns,e.parent.rows[e.row].ref.removeChild(e.el),0==e.parent.rows[e.row].used?(e.parent.container.removeChild(e.parent.rows[e.row].ref),delete e.parent.rows[e.row]):carbon.types[e.parent.type].reflow.call(e.parent)),_.each(["change","change:"+e.name,"removed:"+e.name],function(t){e.owner.trigger(t,e.owner,e)}.bind(e))}else e.set(null)}.bind(this,a)),a.fields){var d={};d=a.array&&"object"==typeof t[a.name]?t[a.name][i||0]:t[a.name]||{},a.fields=_.map(a.fields,carbon.createField.bind(this,a,d,null,null)),a.array&&_.each(a.fields,carbon.inflate.bind(this,d))}return carbon.processConditions.call(a,a.display,function(e){this.el.style.display=e?"block":"none",this.visible=e}),carbon.processConditions.call(a,a.enable,function(e){this.enabled=e,carbon.types[this.type].enable.call(this,this.enabled)}),carbon.processConditions.call(a,a.parse,function(e){this.parsable=e}),carbon.processConditions.call(a,a.validate.required,function(e){this.validate.required=e,this.update()}),a},carbon.ajax=function(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4===t.readyState&&(200===t.status?e.success(JSON.parse(t.responseText)):console.log(t.responseText))},t.open(e.verb||"GET",e.path),t.send()},carbon.default={type:"text",format:{label:"{{label}}",value:"{{value}}"}},carbon.prototype.opts={clear:!0,sections:"",suffix:":",rowClass:"row",requiredText:'<span style="color:red">*</span>'},carbon.optionsObj=function(e,t,n){if("undefined"!=typeof e.max)for(var i=e.min||0;i<=e.max;i+=e.step||1)e.options.push(""+i);return _.map(e.options,function(e,i){return("string"==typeof e||"number"==typeof e)&&(e={label:e,value:e}),e.index=e.index||""+(n+i),_.assignIn(e,{label:carbon.renderString(this.format.label,e),value:carbon.renderString(this.format.value,e)}),e.value==t&&(e.selected=!0),e}.bind(e))},carbon.options=function(e,t,n){n=n||0;var i={options:[]};return"object"!=typeof e||_.isArray(e)||_.merge(i,e),"function"==typeof e&&(i.action=e,i.options=i.action.call(this)),"string"==typeof e||"string"==typeof i.url?(i.path=e.url||e,i.options=!1,i.url=null,carbon.ajax({path:i.path,success:function(e){this.options.options=e,this.options=carbon.options.call(this,this.options,this.value),this.update()}.bind(this)}),i):(e=_.isArray(e)?_.merge({options:[]},carbon.default,{options:e}):_.merge({options:[]},carbon.default,e),i.options=carbon.optionsObj(e,t,n),_.isArray(e.optgroups)&&(n=n||i.options.length-1,_.each(e.optgroups,function(e){e.options=carbon.optionsObj(_.merge({options:[]},carbon.default,e),t,n),e.id=carbon.getUID(),i.options.push({section:e}),carbon.processConditions.call(this,e.enable,function(e,t){for(var n=this.el.querySelectorAll('[data-id="'+e+'"]'),i=0;i<n.length;i++)n[i].disabled=!t}.bind(this,e.id)),carbon.processConditions.call(this,e.display,function(e,t){for(var n=this.el.querySelectorAll('[data-id="'+e+'"]'),i=0;i<n.length;i++)n[i].hidden=!t}.bind(this,e.id)),n+=e.options.length}.bind(this))),"string"==typeof e.placeholder&&i.options.unshift({label:e.placeholder,value:"",enabled:!1,visible:!1,selected:!0}),i)},carbon.VERSION="0.0.0.2",carbon.i=0,carbon.getUID=function(){return"f"+carbon.i++},carbon.types={input:{defaults:{},create:function(){var e=document.createElement("span");return e.setAttribute("id",this.id),e.setAttribute("class"," "+carbon.columnClasses[this.columns]),e.innerHTML=this.render(),e},render:function(){return carbon.render(this.type,this)},destroy:function(){this.el.removeEventListener("change",this.onchangeEvent),this.el.removeEventListener("change",this.onchange),this.el.removeEventListener("input",this.onchangeEvent)},initialize:function(){void 0!==this.onchange&&this.el.addEventListener("change",this.onchange),this.onchangeEvent=function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(this),this.el.addEventListener("change",this.onchangeEvent),this.el.addEventListener("input",this.onchangeEvent)},update:function(e,t){"object"==typeof e&&_.extend(this,this.item,e);var n=document.getElementById(this.id);this.destroy(),this.el=carbon.types[this.type].create.call(this),n.parentNode.replaceChild(this.el,n),carbon.types[this.type].initialize.call(this),t||(this.owner.trigger("change:"+this.name,this),this.owner.trigger("change",this))},get:function(){return this.el.querySelector('input[name="'+this.name+'"]').value},set:function(e){this.el.querySelector('input[name="'+this.name+'"]').value=e},satisfied:function(e){return"undefined"!=typeof e&&null!==e&&""!==e},enable:function(e){this.el.querySelector("input").disabled=!e}},textarea:{defaults:{},set:function(e){this.selected=e==this.options[1],this.el.querySelector('textarea[name="'+this.name+'"]').innerHTML=e},get:function(){return this.el.querySelector('textarea[name="'+this.name+'"]').value}},bool:{defaults:{options:[!1,!0]},render:function(){return this.selected=this.value==this.options[1],carbon.render(this.type,this)},set:function(e){this.selected=e==this.options[1],this.el.querySelector('input[name="'+this.name+'"]').checked=this.selected},get:function(){return this.options[this.el.querySelector('input[name="'+this.name+'"]').checked?1:0]}},collection:{render:function(){return this.options=carbon.options.call(this,this.options,this.value),carbon.render(this.type,this)},initialize:function(){void 0!==this.onchange&&this.el.addEventListener("change",this.onchange),this.el.addEventListener("change",function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(this))},get:function(){return this.el.querySelector('select[name="'+this.name+'"]').value},set:function(e){this.el.querySelector('[name="'+this.name+'"]').value=e,_.each(this.options.options,function(t,n){(t.value==e||parseInt(t.value)==parseInt(e))&&(this.el.querySelector('[name="'+this.name+'"]').selectedIndex=n)}.bind(this))}},section:{initialize:function(){this.rows={}},render:function(){return this.owner.options.sections?carbon.render(this.owner.options.sections+"_fieldset",this):carbon.render("_fieldset",this)},get:function(){},reflow:function(){_.each(this.fields,function(){}.bind(this.rows))}}},carbon.render=function(e,t){return carbon.m(carbon.stencils[e||"text"]||carbon.stencils.text,_.extend({},carbon.stencils,t))},carbon.renderString=function(e,t){return carbon.m(e||"",t||{})},carbocarbon.types.text=carbon.types.number=carbon.types.color=carbon.types.input,carbon.types.hidden=_.extend({},carbon.types.input,{defaults:{columns:0}}),carbon.types.textarea=_.extend({},carbon.types.input,carbon.types.textarea),carbon.types.checkbox=_.extend({},carbon.types.input,carbon.types.bool),carbon.types.fieldset=_.extend({},carbon.types.input,carbon.types.section),carbon.types.select=_.extend({},carbon.types.input,carbon.types.collection),carbon.types.radio=_.extend({},carbon.types.input,carbon.types.collection,{get:function(){return(this.el.querySelector('[type="radio"][name="'+this.name+'"]:checked')||{value:""}).value},set:function(e){this.el.querySelector('[value="'+e+'"]').checked="checked"}}),carbon.types.email=_.extend({},carbon.types.input,{defaults:{validate:{valid_email:!0}}}); carbon.prototype.events=function(n){"use strict";var o={},e={};return e.on=function(n,e){"object"!=typeof o[n]&&(o[n]=[]),o[n].push(e)},e.off=function(e,t){var r=n.indexOf(o[e],t);-1===r?console.warn("Handler not found for event "+e+":",t):o[e].splice(r,1)},e.trigger=function(t){var r=Array.prototype.slice.call(arguments,1);n.each(o[t],function(n){n.apply(e,r)})},e.debounce=function(o,t){e.on(o,n.debounce(t,250))},e}(_); carbon.processConditions=function(n,e){return"string"==typeof n&&("display"===n||"enable"===n||"parse"===n?n=this.item[n]:"enable"===n&&(n=this.item.enable)),"boolean"==typeof n?n:"object"==typeof n?_.map(n,function(n,t){return carbon.conditions[t].call(this,this.owner,n,e||n.callBack)}.bind(this)):!0},carbon.conditions={requires:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,null!==e.value&&""!==e.value,a)}.bind(this,e))},not_matches:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,n.value!==e.value,a)}.bind(this,e))},test:function(n,e,t){return n.events.on("change:"+this.name,function(n,e,i,a){t.call(this,n(),a)}.bind(this,e))},contains:function(n,e,t){return n.on("change:"+e.name,$.proxy(function(n,e,i,a){t.call(this,"undefined"!=typeof e.value&&-1!==e.value.indexOf(n.value),a)},this,e)).lastToken},matches:function(n,e,t){var i=function(e){t.call(this,function(n,e){for(var t=!0,i=0;t&&i<n.length;){var a=n[i].value,o=e.toJSON()[n[i++].name];t="object"==typeof a&&null!==o?-1!==a.indexOf(o):a==o}return t}(e,n))}.bind(this,e);for(var a in e)n.events.on("change:"+e[a].name,i)}}; carbon.prototype.errors={},carbon.prototype.validate=function(){return carbon.clearErrors.call(this),_.each(this.fields,carbon.validateItem),this.valid},carbon.handleError=carbon.update,carbon.validateItem=function(e){carbon.performValidate(e),e.owner.errors[e.name]=e.errors,e.owner.valid=e.valid&&e.owner.valid},carbon.performValidate=function(e,a){var t=e,r=e.get();if("undefined"!=typeof a&&(r=a),e.valid=!0,e.errors="","undefined"!=typeof t.validate&&"object"==typeof t.validate&&t.isParsable)for(var n in t.validate){if(!carbon.validations[n].method.call(e,r,t.validate[n])&&("undefined"==typeof t.show||e.isVisible)){e.valid=!1;var s=carbon.validations[n].message;"string"==typeof t.validate[n]&&(s=t.validate[n]),e.errors=carbon.renderString(s,t)}carbon.handleError(e)}},carbon.clearErrors=function(){this.valid=!0,this.errors={}},carbon.regex={numeric:/^[0-9]+$/,decimal:/^\-?[0-9]*\.?[0-9]+$/},carbon.validations={required:{method:function(e){return this.satisfied(e)},message:"{{label}} is required."},matches:{method:function(e,a){return el==this.carbon[a]?e===el.value:!1},message:"{{label}} does not match the %s field."},date:{method:function(e){return/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}$/.test(e)||""===e},message:"{{label}} should be in the format MM/DD/YYYY."},valid_url:{method:function(e){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(e)||""===e},message:"{{label}} must contain a valid Url."},valid_email:{method:function(e){return/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,6}$/i.test(e)||""===e},message:"{{label}} must contain a valid email address."},min_length:{method:function(e,a){return carbon.regex.numeric.test(a)?e.length>=parseInt(a,10):!1},message:"{{label}} must be at least %s characters in length."},max_length:{method:function(e,a){return carbon.regex.numeric.test(a)?e.length<=parseInt(a,10):!1},message:"{{label}} must not exceed %s characters in length."},exact_length:{method:function(e,a){return carbon.regex.numeric.test(a)?e.length===parseInt(a,10):!1},message:"{{label}} must be exactly %s characters in length."},greater_than:{method:function(e,a){return carbon.regex.decimal.test(e)?parseFloat(e)>parseFloat(a):!1},message:"{{label}} must contain a number greater than %s."},less_than:{method:function(e,a){return carbon.regex.decimal.test(e)?parseFloat(e)<parseFloat(a):!1},message:"{{label}} must contain a number less than %s."},numeric:{method:function(e){return carbon.regex.numeric.test(e)||""===e},message:"{{label}} must contain only numbers."}};
