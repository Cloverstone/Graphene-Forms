var carbon=function(e,t){"use strict";this.options=_.assignIn({legend:"",data:{},columns:carbon.columns},this.opts,e),this.el=document.querySelector(t||e.el),this.el.innerHTML=carbon.render("container",this.options),this.container=this.el.querySelector((t||e.el)+" form"),this.rows={};var n=function(e){if("string"==typeof e)return _.find(this.fields,{name:e}).get();var t={};return _.each(this.fields,function(e){e.parsable&&(e.fields?e.array?(t[e.name]=t[e.name]||[],t[e.name].unshift(n.call(e))):t[e.name]=n.call(e):e.array?(t[e.name]=t[e.name]||[],t[e.name].unshift(e.get())):t[e.name]=e.get())}.bind(this)),t};this.toJSON=n.bind(this),this.set=function(e,t){_.find(this.fields,{name:e}).set(t)}.bind(this),this.field=function(e){return _.find(this.fields,{name:e})}.bind(this),this.on=this.events.on,this.trigger=this.events.trigger,this.debounce=this.events.debounce,this.fields=_.map(this.options.fields,carbon.createField.bind(this,this,this.options.data||{},null,null)),_.each(this.fields,carbon.inflate.bind(this,this.options.data||{})),_.each(this.fields,function(e){e.owner.events.trigger("change:"+e.name,e)}),this.isActive=!0,this.active=function(){return this.isActive}};carbon.inflate=function(e,t,n,i){var a;if(!(a=t.array?_.findLast(i,{name:_.uniqBy(i,"name")[n].name}):_.findLast(i,{name:i[n].name})).array&&a.fields&&_.each(a.fields,carbon.inflate.bind(this,e[a.name]||{})),a.array&&"object"==typeof e[a.name]&&e[a.name].length>1)for(var s=1;s<e[a.name].length;s++){var r=carbon.createField.call(this,a.parent,e,a.el,s,a.item);a.parent.fields.splice(_.findIndex(a.parent.fields,{id:a.id}),0,r),a=r}},carbon.createField=function(e,t,n,i,a){a.type=a.type||"text";var s=_.assignIn({name:(a.label||"").toLowerCase().split(" ").join("_"),id:carbon.getUID(),label:a.legend||a.name,validate:!1,valid:!0,parsable:!0,visible:!0,enabled:!0,parent:e,array:!1,columns:this.options.columns,offset:0},carbon.types[a.type].defaults,a);s.item=a,s.owner=this,s.columns>this.options.columns&&(s.columns=this.options.columns),s.array&&"object"==typeof t[s.name]?s.value=t[s.name][i||0]:s.value=t[s.name]||s.value||s.default,0!==s.item.value?s.array&&"object"==typeof t[s.name]?s.value=t[s.name][i||0]:"function"==typeof s.item.value?(s.valueFunc=item.value,s.derivedValue=function(){return s.valueFunc.call(s.owner.toJSON())},s.item.value=s.item.value=s.derivedValue(),s.owner.on("change",function(){this.set(this.derivedValue())}.bind(s))):s.value=t[s.name]||s.value||s.default||"":s.value=0,s.satisfied=carbon.types[s.type].satisfied.bind(s),s.active=function(){return this.parent.active()&&this.enabled&&this.parsable&&this.visible},s.set=function(e,t){this.value!=e&&"object"!=typeof e&&(this.value=e,carbon.types[this.type].set(e),t||this.trigger("change"))}.bind(s),s.get=carbon.types[s.type].get.bind(s),s.render=carbon.types[s.type].render.bind(s),s.el=carbon.types[s.type].create.call(s),s.container=s.el.querySelector("fieldset")||null,"fieldset"==s.type&&(s.rows={});var r,o=s.parent.container.querySelectorAll("form > .row,fieldset > .row");if(void 0!==(l=(o[o.length-1]||{}).id)&&(r=s.parent.rows[l]),void 0===r||r.used+parseInt(s.columns,10)+parseInt(s.offset,10)>this.options.columns){var l=carbon.getUID();(r={}).used=0,r.ref=document.createElement("div"),r.ref.setAttribute("id",l),r.ref.setAttribute("class","row"),s.parent.rows[l]=r,s.parent.container.appendChild(r.ref)}r.used+=parseInt(s.columns,10),r.used+=parseInt(s.offset,10),r.ref.appendChild(s.el),s.row=l,carbon.types[s.type].initialize.call(s);var c=s.el.querySelector(".carbon-add");null!==c&&c.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true<(e.array.max||5)){var t=_.findIndex(e.parent.fields,{id:e.id}),n=carbon.createField.call(this,e.parent,{},e.el,null,e.item);e.parent.fields.splice(t,0,n),n.el.querySelector('[name="'+e.name+'"]').focus(),_.each(["change","change:"+e.name,"create:"+e.name,"inserted:"+e.name],_.partialRight(this.trigger,e))}}.bind(this,s));var d=s.el.querySelector(".carbon-minus");if(null!==d&&d.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true>(e.array.min||1)){var t=_.findIndex(e.parent.fields,{id:e.id});e.parent.fields.splice(t,1),e.parent.rows[e.row].used-=e.offset+e.columns,e.parent.rows[e.row].ref.removeChild(e.el),0==e.parent.rows[e.row].used&&e.parent.container.removeChild(e.parent.rows[e.row].ref),_.each(["change","change:"+e.name,"removed:"+e.name],_.partialRight(this.trigger,e))}else e.set(null)}.bind(this,s)),s.fields){var u={};u=s.array&&"object"==typeof t[s.name]?t[s.name][i||0]:t[s.name]||{},s.fields=_.map(s.fields,carbon.createField.bind(this,s,u,null,null)),s.array&&_.each(s.fields,carbon.inflate.bind(this,u))}return carbon.processConditions.call(s,s.display,function(e){this.el.style.display=e?"block":"none",this.visible=e}),carbon.processConditions.call(s,s.enable,function(e){this.enabled=e,carbon.types[this.type].enable.call(this,this.enabled)}),carbon.processConditions.call(s,s.parse,function(e){this.parsable=e}),s},carbon.update=function(e){e.el.innerHTML=carbon.types[e.type].render.call(e);var t=document.getElementById(e.id);t.parentNode.replaceChild(e.el,t)},carbon.ajax=function(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4===t.readyState&&(200===t.status?e.success(JSON.parse(t.responseText)):console.log(t.responseText))},t.open(e.verb||"GET",e.path),t.send()},carbon.default={label_key:"label",value_key:"value"},carbon.prototype.opts={suffix:":",required:'<span style="color:red">*</span>'},carbon.options=function(e){if("function"==typeof e.options&&(e.action=e.options,e.options=e.action.call(this,e)),"string"==typeof e.options)return e.path=e.options,e.options=!1,carbon.ajax({path:e.path,success:function(e,t){e.options=t,e=carbon.options(e),carbon.update(e)}.bind(null,e)}),e;if(void 0!==(e=_.assignIn({options:[]},carbon.default,e)).max){e.min=e.min||0,e.step=e.step||1;for(var t=e.min;t<=e.max;)e.options.push(t.toString()),t+=e.step}return e.options=_.map(e.options,function(t,n){"string"!=typeof t&&"number"!=typeof t||(t={label:t},"index"!==this.value_key&&(t.value=t.label));var i=_.assignIn({label:t[e.label_key],value:t[e.value_key]||n},t);return i.value==e.value&&(i.selected=!0),i}.bind(e)),void 0!==e.default&&e.options[0]!==e.default&&e.options.unshift(e.default),e},carbon.types={basic:{defaults:{},create:function(){var e=document.createElement("span");return e.setAttribute("id",this.id),e.setAttribute("class"," "+carbon.columnClasses[this.columns]),e.innerHTML=this.render(),e},render:function(){return carbon.render(this.type,this)},initialize:function(){void 0!==this.onchange&&this.el.addEventListener("change",this.onchange);var e=function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(this);this.el.addEventListener("change",e),this.el.addEventListener("input",e)},get:function(){return this.el.querySelector('[name="'+this.name+'"]').checked||this.el.querySelector('[name="'+this.name+'"]').value},set:function(e){this.el.querySelector('[name="'+this.name+'"]').value=e},satisfied:function(e){return void 0!==e&&null!==e&&""!==e},enable:function(e){this.el.querySelector("input").disabled=!e}},list:{render:function(){return _.assignIn(this,carbon.options.call(this.owner,this)),carbon.render(this.type,this)},initialize:function(){void 0!==this.onchange&&this.el.addEventListener("change",this.onchange),this.el.addEventListener("change",function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(this))},get:function(){return this.el.querySelector('[name="'+this.name+'"]').value},set:function(e){this.el.querySelector('[name="'+this.name+'"]').value=e,_.each(this.options,function(t,n){t.value==e&&(this.el.querySelector('[name="'+this.name+'"]').selectedIndex=n)}.bind(this))}}},carbon.i=0,carbon.getUID=function(){return"f"+carbon.i++},carbon.types.text=carbon.types.checkbox=carbon.types.fieldset=carbon.types.color=carbon.types.basic,carbon.types.radio=carbon.types.select=_.extend({},carbon.types.basic,carbon.types.list),carbon.types.email=_.extend({},carbon.types.basic,{defaults:{validate:{valid_email:!0}}}); carbon.prototype.events=function(n){"use strict";var o={},e={};return e.on=function(n,e){"object"!=typeof o[n]&&(o[n]=[]),o[n].push(e)},e.off=function(e,t){var c=n.indexOf(o[e],t);-1===c?console.warn("Handler not found for event "+e+":",t):o[e].splice(c,1)},e.trigger=function(t){var c=Array.prototype.slice.call(arguments,1);n.each(o[t],function(n){n.apply(e,c)})},e.debounce=function(o,t){e.on(o,n.debounce(t,250))},e}(_); carbon.processConditions=function(n,e){return"string"==typeof n&&("display"===n||"enable"===n||"parse"===n?n=this.item[n]:"enable"===n&&(n=this.item.enable)),"boolean"==typeof n?n:"object"!=typeof n||_.map(n,function(n,t){return carbon.conditions[t].call(this,this.owner,n,e||n.callBack)}.bind(this))},carbon.conditions={requires:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,null!==e.value&&""!==e.value,a)}.bind(this,e))},not_matches:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,n.value!==e.value,a)}.bind(this,e))},test:function(n,e,t){return n.events.on("change:"+this.name,function(n,e,i,a){t.call(this,n(),a)}.bind(this,e))},contains:function(n,e,t){return n.on("change:"+e.name,$.proxy(function(n,e,i,a){t.call(this,void 0!==e.value&&-1!==e.value.indexOf(n.value),a)},this,e)).lastToken},matches:function(n,e,t){var i=function(e,i){t.call(this,function(n,e){for(var t=!0,i=0;t&&i<n.length;){var a=n[i].value,o=e.toJSON()[n[i++].name];t="object"==typeof a&&null!==o?-1!==a.indexOf(o):a==o}return t}(e,n))}.bind(this,e);for(var a in e)n.events.on("change:"+e[a].name,i)}}; carbon.prototype.errors={},carbon.prototype.validate=function(){return carbon.clearErrors.call(this),_.each(this.fields,carbon.validateItem),this.valid},carbon.handleError=carbon.update,carbon.validateItem=function(e){carbon.performValidate(e),e.owner.errors[e.name]=e.errors,e.owner.valid=e.valid&&e.owner.valid},carbon.performValidate=function(e,a){var t=e,r=e.get();if(void 0!==a&&(r=a),e.valid=!0,e.errors="",void 0!==t.validate&&"object"==typeof t.validate&&t.parsable)for(var n in t.validate){if(!carbon.validations[n].method.call(e,r,t.validate[n])&&(void 0===t.show||e.isVisible)){e.valid=!1;var l=carbon.validations[n].message;"string"==typeof t.validate[n]&&(l=t.validate[n]),e.errors=l.replace("{{label}}",t.label)}carbon.handleError(e)}},carbon.clearErrors=function(){this.valid=!0,this.errors={}},carbon.regex={numeric:/^[0-9]+$/,integer:/^\-?[0-9]+$/,decimal:/^\-?[0-9]*\.?[0-9]+$/,email:/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,6}$/i,url:/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,date:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}$/},carbon.validations={required:{method:function(e,a){return this.satisfied(e)},message:"The {{label}} field is required."},matches:{method:function(e,a){return el==this.carbon[a]&&e===el.value},message:"The {{label}} field does not match the %s field."},date:{method:function(e,a){return carbon.regex.date.test(e)||""===e},message:"The {{label}} field should be in the format MM/DD/YYYY."},valid_url:{method:function(e){return carbon.regex.url.test(e)||""===e},message:"The {{label}} field must contain a valid Url."},valid_email:{method:function(e){return carbon.regex.email.test(e)||""===e},message:"The {{label}} field must contain a valid email address."},valid_emails:{method:function(e){for(var a=e.split(","),t=0;t<a.length;t++)if(!carbon.regex.email.test(a[t]))return!1;return!0},message:"The {{label}} field must contain all valid email addresses."},min_length:{method:function(e,a){return!!carbon.regex.numeric.test(a)&&e.length>=parseInt(a,10)},message:"The {{label}} field must be at least %s characters in length."},max_length:{method:function(e,a){return!!carbon.regex.numeric.test(a)&&e.length<=parseInt(a,10)},message:"The {{label}} field must not exceed %s characters in length."},exact_length:{method:function(e,a){return!!carbon.regex.numeric.test(a)&&e.length===parseInt(a,10)},message:"The {{label}} field must be exactly %s characters in length."},greater_than:{method:function(e,a){return!!carbon.regex.decimal.test(e)&&parseFloat(e)>parseFloat(a)},message:"The {{label}} field must contain a number greater than %s."},less_than:{method:function(e,a){return!!carbon.regex.decimal.test(e)&&parseFloat(e)<parseFloat(a)},message:"The {{label}} field must contain a number less than %s."},numeric:{method:function(e){return carbon.regex.decimal.test(e)||""===e},message:"The {{label}} field must contain only numbers."}};
