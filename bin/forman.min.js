var forman=function(e,t){document.querySelector(e).innerHTML=forman.stencils.container(_.assignIn({legend:""},t)),this.form=document.querySelector(e+" form"),this.fields=_.map(t.fields,function(e){return e=_.assignIn({name:(e.label||"").toLowerCase().split(" ").join("_"),id:forman.getUID(),type:"text","extends":"basic",label:e.name,value:t.attributes[e.name]||e.default},e),("select"==e.type||"radio"==e.type)&&(e=_.assignIn(e,forman.processOptions.call(this,e))),e}),_.each(this.fields,function(e){e.el=document.createElement("div"),e.el.setAttribute("id",e.id),e.el.innerHTML=(forman.stencils[e.type]||forman.stencils.text)(e),this.form.appendChild(e.el)}.bind(this));var n=function(){var e={};return _.each(this.fields,function(t){e[t.name]=this.form.querySelector('[name="'+t.name+'"]').value}.bind(this)),e};return{toJSON:n.bind(this)}};forman.ajax=function(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4===t.readyState&&(200===t.status?e.success(JSON.parse(t.responseText)):console.log(t.responseText))},t.open(e.verb||"GET",e.path),t.send()},forman.default={label_key:"label",value_key:"value"},forman.processOptions=function(e){if("string"==typeof e.options)return e.path=e.options,e.options=!1,forman.ajax({path:e.path,success:function(e){this.field.options=e,this.field=forman.processOptions(this.field),this.field.el.innerHTML=(forman.stencils[this.field.type]||forman.stencils.text)(this.field);var t=document.getElementById(this.field.id);t.parentNode.replaceChild(this.field.el,t)}.bind({field:e})}),e;if(e=_.assignIn({options:[]},forman.default,e),"undefined"!=typeof e.max){e.min=e.min||0,e.step=e.step||1;for(var t=e.min;t<=e.max;)e.options.push(t.toString()),t+=e.step}return"undefined"!=typeof e.default&&e.options[0]!==e.default&&e.options.unshift(e.default),e.options=_.map(e.options,function(t,n){return("string"==typeof t||"number"==typeof t)&&(t={label:t},"index"!==this.value_key&&(t.value=t.label)),_.assignIn({label:t[e.label_key],value:t[e.value_key]||n},t)}.bind(e)),e},forman.i=0,forman.getUID=function(){return"f"+forman.i++}; forman.stencils={container:_.template('<div class="forman"><legend for="<%= name %>"><%= legend %></legend> <form></form></div>'),text:_.template('<div><label for="<%= name %>"><%= label %></label> <input name="<%= name %>" type="<%=type%>" value="<%=value%>" id="<%=id%>" /></div>'),select:_.template('<div><label for="<%=name%>"><%= label %></label> <select name="<%= name %>" value="<%=value%>" id="<%=id%>" /><% _.forEach(options, function(option) { %><option value="<%- option.value %>"><%- option.label %></option><% }); %></select></div>'),radio:_.template('<div><label><%= label %></label> <% _.forEach(options, function(option) { %><label><input name="<%=name%>" value="<%=option.value%>" type="radio"><%=option.label%></label><% }); %> </div>')};
