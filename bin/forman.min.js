var forman=function(e,n){this.options=_.assignIn({legend:"",attributes:{}},this.opts,e),document.querySelector(n).innerHTML=forman.stencils.container(this.options),this.el=document.querySelector(n+" form"),this.fields=_.map(this.options.fields,forman.initialize.bind(this,this,this.options.attributes||{},null)),_.each(this.fields,function(e){e.owner.events.trigger("change:"+e.name,e)});var t=function(e){if("string"==typeof e)return _.find(this.fields,{name:e}).get();var n={};return _.each(this.fields,function(e){e.fields?e.array?(n[e.name]=n[e.name]||[],n[e.name].unshift(t.call(e))):n[e.name]=t.call(e):e.array?(n[e.name]=n[e.name]||[],n[e.name].unshift(e.get())):n[e.name]=e.get()}.bind(this)),n};this.toJSON=t.bind(this),this.set=function(e,n){_.find(this.fields,{name:e}).set(n)}.bind(this),this.field=function(e){return _.find(this.fields,{name:e})}.bind(this),this.on=this.events.on,this.trigger=this.events.trigger,this.debounce=this.events.debounce};forman.initialize=function(e,n,t,i){var s=_.assignIn({name:(i.label||"").toLowerCase().split(" ").join("_"),id:forman.getUID(),type:"text","extends":"basic",label:i.legend||i.name,validate:!1,valid:!0,parent:e,array:!1},i);s.item=i,s.value=n[s.name]||s.value||s.default,s.owner=this,s.satisfied=function(e){return"undefined"!=typeof e&&null!==e&&""!==e}.bind(s),s.set=function(e){this.el.querySelector('[name="'+this.name+'"]').value=e,_.each(this.options,function(n,t){n.value==e&&(this.el.querySelector('[name="'+this.name+'"]').selectedIndex=t)}.bind(this))}.bind(s),s.get=function(){return this.el.querySelector('[name="'+this.name+'"]').checked||this.el.querySelector('[name="'+this.name+'"]').value}.bind(s),forman.processConditions.call(s,s.display,function(e){this.el.style.display=e?"block":"none"}.bind(s)),forman.processConditions.call(s,s.visible,function(e){this.el.style.visibility=e?"visible":"hidden"}.bind(s)),forman.processConditions.call(s,s.enable,function(e){this.enabled=e}.bind(s)),forman.processConditions.call(s,s.parsable,function(e){this.el.style.parsable=e}.bind(s)),("select"==s.type||"radio"==s.type)&&(s=_.assignIn(s,forman.processOptions.call(this,s))),s.el=document.createElement("div"),s.el.setAttribute("id",s.id),s.el.setAttribute("class","row"),s.el.innerHTML=(forman.stencils[s.type]||forman.stencils.text)(s),null==t||s.parent.el.lastChild==t?s.parent.el.appendChild(s.el):s.parent.el.insertBefore(s.el,t.nextSibling),void 0!==s.onchange&&s.el.addEventListener("change",this.onchange),s.el.addEventListener("change",function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(s)),s.el.addEventListener("input",function(){this.value=this.get(),this.owner.events.trigger("change:"+this.name,this),this.owner.events.trigger("change",this)}.bind(s));var a=s.el.querySelector(".forman-add");null!==a&&a.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true<(e.array.max||5)){var n=_.findIndex(e.parent.fields,{id:e.id}),t={};e.parent.fields.splice(n,0,forman.initialize.call(this,e.parent,t,e.el,e.item))}}.bind(this,s));var o=s.el.querySelector(".forman-minus");return null!==o&&o.addEventListener("click",function(e){if(_.countBy(e.parent.fields,{name:e.name}).true>(e.array.min||1)){var n=_.findIndex(e.parent.fields,{id:e.id});e.parent.fields.splice(n,1),e.parent.el.removeChild(e.el)}else e.set(null)}.bind(this,s)),s.fields&&(s.fields=_.map(s.fields,forman.initialize.bind(this,s,n[s.name]||{},null))),s},forman.update=function(e){e.el.innerHTML=(forman.stencils[e.type]||forman.stencils.text)(e);var n=document.getElementById(e.id);n.parentNode.replaceChild(e.el,n)},forman.ajax=function(e){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(200===n.status?e.success(JSON.parse(n.responseText)):console.log(n.responseText))},n.open(e.verb||"GET",e.path),n.send()},forman.default={label_key:"label",value_key:"value"},forman.prototype.opts={suffix:":",required:'<span style="color:red">*</span>'},forman.processOptions=function(e){if("function"==typeof e.options&&(e.action=e.options,e.options=e.action.call(this,e)),"string"==typeof e.options)return e.path=e.options,e.options=!1,forman.ajax({path:e.path,success:function(e,n){e.options=n,e=forman.processOptions(e),forman.update(e)}.bind(null,e)}),e;if(e=_.assignIn({options:[]},forman.default,e),"undefined"!=typeof e.max){e.min=e.min||0,e.step=e.step||1;for(var n=e.min;n<=e.max;)e.options.push(n.toString()),n+=e.step}return e.options=_.map(e.options,function(n,t){("string"==typeof n||"number"==typeof n)&&(n={label:n},"index"!==this.value_key&&(n.value=n.label));var i=_.assignIn({label:n[e.label_key],value:n[e.value_key]||t},n);return i.value==e.value&&(i.selected=!0),i}.bind(e)),"undefined"!=typeof e.default&&e.options[0]!==e.default&&e.options.unshift(e.default),e},forman.i=0,forman.getUID=function(){return"f"+forman.i++}; forman.prototype.events=function(n){"use strict";var o={},e={};return e.on=function(n,e){"object"!=typeof o[n]&&(o[n]=[]),o[n].push(e)},e.off=function(e,t){var r=n.indexOf(o[e],t);-1===r?console.warn("Handler not found for event "+e+":",t):o[e].splice(r,1)},e.trigger=function(t){var r=Array.prototype.slice.call(arguments,1);n.each(o[t],function(n){n.apply(e,r)})},e.debounce=function(o,t){e.on(o,n.debounce(t,250))},e}(_); forman.processConditions=function(n,e){if("string"==typeof n&&("show"===n||"enabled"===n||"parsable"===n?n=this.item[n]:"enable"===n&&(n=this.item.enable)),"boolean"==typeof n)return n;if("object"==typeof n){var t=[];for(var i in n)t.push(forman.conditions[i].call(this,this.owner,n[i],e||n[i].callBack));return t}return!0},forman.conditions={requires:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,null!==e.value&&""!==e.value,a)}.bind(this,e))},not_matches:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this,n.value!==e.value,a)}.bind(this,e))},matches:function(n,e,t){return n.events.on("change:"+e.name,function(n,e,i,a){t.call(this.self,n.value===e.get(),a)}.bind(this,e))},test:function(n,e,t){return n.on("change:"+this.name,function(n,e,i,a){t.call(this,n(),a)}.bind(this,e))},multiMatch:function(n,e,t){return n.on("change:"+_.pluck(e,"name").join(" change:"),function(e){t.call(this,function(n,e){var t=!1;for(var i in n){var a=n[i].value,o=e.toJSON()[n[i].name];if(t="object"==typeof a&&null!==o?-1!==a.indexOf(o):a==o,!t)break}return t}(e,n),"mm")}.bind(this,e)),"mm"}}; forman.prototype.errors={},forman.prototype.validate=function(){return forman.clearErrors.call(this),_.each(this.fields,forman.validateItem),this.valid},forman.handleError=forman.update,forman.validateItem=function(e){forman.performValidate(e),e.owner.errors[e.name]=e.errors,e.owner.valid=e.valid&&e.owner.valid},forman.performValidate=function(e,a){var t=e,r=e.get();if("undefined"!=typeof a&&(r=a),e.valid=!0,e.errors="","undefined"!=typeof t.validate&&"object"==typeof t.validate)for(var n in t.validate){if(!forman.validations[n].method.call(e,r,t.validate[n])&&("undefined"==typeof t.show||e.isVisible)){e.valid=!1;var l=forman.validations[n].message;"string"==typeof t.validate[n]&&(l=t.validate[n]),e.errors=l.replace("{{label}}",t.label)}forman.handleError(e)}},forman.clearErrors=function(){this.valid=!0,this.errors={}},forman.regex={numeric:/^[0-9]+$/,integer:/^\-?[0-9]+$/,decimal:/^\-?[0-9]*\.?[0-9]+$/,email:/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,6}$/i,url:/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,date:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}$/},forman.validations={required:{method:function(e){return this.satisfied(e)},message:"The {{label}} field is required."},matches:{method:function(e,a){return el==this.forman[a]?e===el.value:!1},message:"The {{label}} field does not match the %s field."},date:{method:function(e){return forman.regex.date.test(e)||""===e},message:"The {{label}} field should be in the format MM/DD/YYYY."},valid_url:{method:function(e){return forman.regex.url.test(e)||""===e},message:"The {{label}} field must contain a valid Url."},valid_email:{method:function(e){return forman.regex.email.test(e)||""===e},message:"The {{label}} field must contain a valid email address."},valid_emails:{method:function(e){for(var a=e.split(","),t=0;t<a.length;t++)if(!forman.regex.email.test(a[t]))return!1;return!0},message:"The {{label}} field must contain all valid email addresses."},min_length:{method:function(e,a){return forman.regex.numeric.test(a)?e.length>=parseInt(a,10):!1},message:"The {{label}} field must be at least %s characters in length."},max_length:{method:function(e,a){return forman.regex.numeric.test(a)?e.length<=parseInt(a,10):!1},message:"The {{label}} field must not exceed %s characters in length."},exact_length:{method:function(e,a){return forman.regex.numeric.test(a)?e.length===parseInt(a,10):!1},message:"The {{label}} field must be exactly %s characters in length."},greater_than:{method:function(e,a){return forman.regex.decimal.test(e)?parseFloat(e)>parseFloat(a):!1},message:"The {{label}} field must contain a number greater than %s."},less_than:{method:function(e,a){return forman.regex.decimal.test(e)?parseFloat(e)<parseFloat(a):!1},message:"The {{label}} field must contain a number less than %s."},numeric:{method:function(e){return forman.regex.decimal.test(e)||""===e},message:"The {{label}} field must contain only numbers."}};
